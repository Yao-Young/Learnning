#内存管理(一)	概述

[TOC]



##一、冯诺依曼体系结构

![1651648992756](assets\1651648992756.png)

##二、存储系统

![1651668912305](assets\1651668912305.png)



##三、内存空间

内存空间一般分为：

- 系统区，用于存放操作系统内核程序和数据结构等
- 用户区，用于存放应用程序和数据

##四、存储管理

存储管理包含以下功能：

- 内存空间的分配与回收
- 地址映射
- 内存共享
- 存储保护
- 内存扩充



###内存分配与回收

```
1、在操作系统由单道向多道发展时，存储管理方式由单一连续分配发展为固定分区方式
2、为了能更好地适应不同大小的程序要求，又从固定分区方式 到 动态分区分配
3、为了更好地提高内存的利用率，进而从连续分配发展到 离散分配方式——页式存储管理
4、引入分段存储管理的目的，主要是为了满足用户在编程和使用方面的要求，其中某些要求是其他分配方式难以满足的
```

###地址映射

在多道程序环境下，程序中的逻辑地址与内存与内存中的物理地址不可能已知，因而存储管理必须提供地址变换功能，把逻辑地址转为相应的物理地址



###内存共享

并不是所有的进程内存空间都适合共享，只有那些只读的区域才可以共享



###存储扩充

内存速度快但容量小，外存容量大却速度慢，应用程序的大小不应收到物理内存容量限制。为此，操作系统把内存和外存结合起来，形成一个容量近似外存、速度近似内存的虚拟存储器，允许用户的逻辑地址空间大于内存物理地址空间，虚存管理自动在内存和外存之间移动信息





###存储保护

- 内容

```
要保护操作系统不受用户进程的影响，同时保护用户进程不受其他用户进程的影响
系统程序和多个应用程序在内存中各有自己的存储区域，各道程序只能访问自己的内存区而不能相互干扰。
```

- 办法

```
1、在CPU中设置一对上、下限寄存器：
	存放用户作业在主存中的下限和上限地址，每当CPU要访问一个地址时，分别和两个寄存器的值相比，判断有无越界
2、采用重定位寄存器和界地址寄存器：
	
```



###补充

1、逻辑地址与物理地址

2、进程的内存映像

当一个进程调入内存运行时，就构成了进程的内存映像。也就是进程在内存中长什么样

```
代码段：程序的二进制代码，代码段是只读，可被多个进程共享
数据段：即程序运行时加工处理的对象，包括全局变量和静态变量
进程控制块(PCB): 存放在系统区。操作系统通过PCB来控制和管理进程
堆：用来存放动态分配的变量。通过调用malloc函数动态地向高地址分配空间
栈：用来实现函数调用。从用户空间的最大地址向低地址方向增长
```

![1651666428512](assets\1651666428512.png)

##五、存储器工作原理

#### 存储器层次

​	计算机系统的存储器层次结构自上至下依次为：寄存器、缓存、内存、磁盘、磁带

​	存储介质的访问速度由下而上越来越快，容量越来越小，价格越来越高。其中，寄存器、缓存和内存均属于操作系统存储管理的管辖范畴，掉电后它们存储的信息不复存在；磁盘和磁带属于文件管理和设备管理的管辖对象，它们所存储的信息将被持久性保存

​	由于程序处理数据时存在顺序性和局部性，故执行时仅需调入当前运行使用的一部分，其他部分待需要时再逐步调入。据此，计算机系统为了容纳更多作业，或为了处理更大批量数据，可在磁盘上建立磁盘缓存以扩充内存的存储空间，计算程序和所处理的数据可装入磁盘缓存，操作系统自动实现内存和磁盘缓存之间的程序和数据的调进调出，从而向用户提供比实际内存容量大得多的虚拟内存。基于这个原理，就可以设计出多级层级式体系结构的存储子系统。

####程序的预编译、链接和装载

- 编译(compiler / assembly)

```
预处理、编译、汇编成目标模块(涉及程序设计语言、编译程序和汇编程序、操作系统及计算机硬件)
```

![1651656502057](assets\1651656502057.png)

- 程序链接(linker)

一、定义：

1)根据目标模块之间的调用关系和依赖关系，将主调模块、被调用模块以及所用到的库函数装配和链接成一个完整的可装载执行模块。(红书)

2)由链接程序将编译后形成的一组目标模块及它们所需的库函数链接在一起，形成一个完整的装入模块(王道)

二、程序链接的三种方式

根据程序链接发生的时刻和链接方式，程序链接可以分成以下三种方式

```
静态链接
动态链接
运行时链接
```

- 静态链接

  **指在程序装载到内存和运行之前，就已将它的所有目标模块及所需要的库函数进行链接和装配成一个完整的可执行程序且此后不再拆分。**

优缺点

```c
使得链接过程和装载过程相互独立，但不支持内存空间中目标模块的单副本、不利于模块共享
```

需要解决的两个问题

```c
1、修改相对地址，编译后的所有目标都是从0开始的相对地址，当链接成一个模块时要修改相对地址
2、变换外部调用符号，将每个模块中所用的外部符号也都变换为相对地址
```

- 动态链接

  **将用户源程序编译后得到的一组目标模块，在装入内存时，采用边装入边链接的方式，在装载模块时，若发生外部模块调用，将引发相应外部目标模块的搜索、装载和链接。**

优缺点

```
各个目标模块独立存在，便于修改、更新和共享，但由于装载和链接过程交织在一起，增加了设计和开发难度
```

- 运行时动态链接

  **将某些目标模块或库函数的链接推迟到执行时才进行。在程序执行过程中，若发现被调用的模块或库函数尚未链接，先在内存中进行搜索以查看其是否装入内存；若已装入，则直接将其链接到被调用者程序中，否则进行该模块在外存上的搜索，以及装入内存和进行链接，生成一个可执行程序**

优点

```
不用事先直到所有的所需的目标模块，避免程序执行过程中不被调用的某些目标模块在执行前进行链接和装载而引起的开销，提高系统资源利用率和系统效率
```

具体做法

```
不必将程序所需的外部函数代码从系统中提取出并链接到目标模块中，而仅在程序调用处登记调用信息，记录函数名及入口号，形成调用链接。一旦DLL库调入内存后，就可以确定所调函数在内存的物理信息。
```



- 程序装载(loader)

  创建进程首先要将程序和数据装入内存，把可执行程序装入内存的方式有三种：

  - 绝对装载

  ​	**装载模块中的指令地址始终与其内存中的地址相同，即在模块中出现的所有地址都是内存绝对地址**

  - 可重定位装载

    **根据内存当时使用情况，决定将装入代码模块放入内存的适当位置。模块内使用的地址都是相对地址**

  - 动态运行时装载

    **为提高内存利用率，装入内存的程序可换出到磁盘上，适当时候再换入到内存中，对前后程序在内存中的位置可能不同，即允许进程的内存映像在不同时候处于不同位置，此时模块内使用的地址必为相对地址**

    

可执行程序逻辑地址转换为物理地址的过程称为地址重定位、地址映射或地址转换，基于上诉程序装入方式，可区分三种地址重定位:

静态地址重定位

```
	由装载程序事先装载代码模块的加载和地址转换，把它装入分配给进程的内存指定区域，其中的所有逻辑地址修改为内存物理地址，称为静态地址重定位
	地址转换工作在进程执行前一次完成，无须硬件支持，易于实现，但不允许程序在执行过程中移动位置，适用与单用户单任务系统
	
简单地说，就是事先说好放在哪里
```

动态地址重定位:

```
由装载程序实现装载代码模块的加载，把它装入分配给进程的内存指定区域，但对链接程序处理过的应用程序的逻辑地址不做任何修改，程序内存起始地址被置入硬件专用寄存器——重定位寄存器，程序执行过程中，每当CPU引用内存地址(访问程序和数据)时，由硬件截取此逻辑地址，并在它被发送到内存之前加上重定位寄存器的值，以便实现地址转换，称动态地址重定位

简单地说，就是有一片内存空间，每来一个程序，就按顺序放一个.
```

![1651663217912](assets\1651663217912.png)



运行时链接地址重定位	

```
	对于静态和动态地址重定位装载方式而言，装载代码模块是由整个程序的所有目标模块及库函数目标模块经链接和整合构成的可执行程序，即在程序启动前已经完成了程序的链接过程。
	装载代码的正文结构是静态的，在程序的整个执行期间保持不变，且程序每次运行时的装载模块都是相同的。
	但是在实际应用场景中，每次要运行的装载模块可能并不相同，如果由于事先无法直到本次要运行哪些模块就采取将整个程序所有模块在装载时或装载前全部链接在一起的处理方法，必然会导致内存空间利用率及系统执行效率低。所以现代操作系统通常支持动态链接系统库及运行时链接装载方式，不再要求启动执行程序时就装载整个程序的所有模块
	
看程序需要哪个模块，就加载哪个模块
```

具体操作：

```
暂略
```

虚拟存储器使得动态加载可执行代码或共享代码变得十分容易



## 六、实践

```c
//hello.c
#include <stdio.h>
int main(void) {
    printf("Hello World!");
    return 0;
}
```

hello.c的整个编译过程到底是怎样的？

![img](https://pic4.zhimg.com/80/v2-d6bfa8042150d2becd581266c907be17_720w.jpg)

```
预处理 -> 编译 -> 汇编 -> 链接
参考文章：https://zhuanlan.zhihu.com/p/111500914
```

 

##七、Q&A

```
1、什么是存储结构？
2、存储器为什么要分层级？
3、存储管理的主要内容是什么？
4、应用程序是如何在计算机系统上运行呢？
```

##八、总结

